<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>MoodCart â€¢ Home</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
:root {
  --bg: #fdf2ff;
  --bg-elevated: rgba(255, 255, 255, 0.92);
  --surface: #ffffff;
  --accent: #ec4899;
  --accent-strong: #db2777;
  --accent-soft: rgba(236, 72, 153, 0.14);
  --border: rgba(148, 163, 184, 0.28);
  --text: #111827;
  --text-muted: #6b7280;
  --danger: #ef4444;
  --shadow: 0 18px 45px rgba(15, 23, 42, 0.10);
}

* { box-sizing: border-box; }

html, body {
  height: 100%;
}

body {
  margin: 0;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
  background:
    radial-gradient(circle at 0 0, #e0f2fe 0, transparent 55%),
    radial-gradient(circle at 100% 0, #fee2e2 0, transparent 55%),
    radial-gradient(circle at 0 100%, #ede9fe 0, transparent 55%),
    var(--bg);
  color: var(--text);
  overflow-x: hidden;
  overflow-y: auto;
}

a { color: inherit; text-decoration: none; }

.shell {
  height: 100vh;
  display: grid;
  grid-template-rows: auto 1fr auto;
}

.header {
  position: sticky;
  top: 0;
  z-index: 10;
  background: rgba(255, 255, 255, 0.82);
  backdrop-filter: blur(18px);
  border-bottom: 1px solid var(--border);
}

.header-inner {
  max-width: 1320px;
  margin: 0 auto;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 1rem;
  padding: 0.85rem 1.25rem;
}

.brand {
  font-weight: 900;
  letter-spacing: 0.08em;
  text-transform: uppercase;
  font-size: 1.25rem;
  background: linear-gradient(to right, #3b82f6, #ec4899, #22c55e);
  -webkit-background-clip: text;
  color: transparent;
}

.nav {
  display: flex;
  gap: 0.5rem;
  align-items: center;
  flex-wrap: wrap;
}

.nav a {
  padding: 0.4rem 0.75rem;
  border-radius: 999px;
  border: 1px solid transparent;
  color: var(--text);
  font-size: 0.9rem;
}

.nav a.active {
  background: var(--accent-soft);
  border-color: rgba(236, 72, 153, 0.45);
  color: #9d174d;
}

.nav-right {
  display: flex;
  align-items: center;
  gap: 0.6rem;
}

.status {
  font-size: 0.85rem;
  color: var(--text-muted);
  max-width: 45ch;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

main {
  max-width: 1320px;
  margin: 0 auto;
  padding: 1rem 1.25rem;
  overflow: auto;
}

.layout {
  height: 100%;
  display: grid;
  gap: 1rem;
}

.layout.cols-3 {
  grid-template-columns: minmax(280px, 340px) minmax(0, 1fr) minmax(280px, 340px);
}

.panel {
  background: var(--bg-elevated);
  border: 1px solid rgba(233, 213, 255, 0.8);
  border-radius: 1.25rem;
  box-shadow: var(--shadow);
  overflow: hidden;
  display: flex;
  flex-direction: column;
  min-height: 0;
}

.panel-header {
  padding: 0.85rem 1rem;
  border-bottom: 1px solid rgba(233, 213, 255, 0.8);
  background: linear-gradient(135deg, rgba(255, 255, 255, 0.92), rgba(253, 242, 255, 0.85));
}

.panel-header h2 {
  margin: 0;
  font-size: 1rem;
  font-weight: 650;
}

.panel-body {
  padding: 0.9rem 1rem;
  overflow: auto;
}

.hint {
  font-size: 0.82rem;
  color: var(--text-muted);
  margin-top: 0.45rem;
}

.row {
  display: grid;
  gap: 0.75rem;
}

label {
  display: block;
  font-size: 0.8rem;
  color: var(--text-muted);
  margin-bottom: 0.25rem;
}

input[type="email"],
input[type="text"],
input[type="password"] {
  width: 100%;
  padding: 0.6rem 0.85rem;
  border-radius: 999px;
  border: 1px solid rgba(209, 213, 219, 0.9);
  background: rgba(255, 255, 255, 0.95);
  color: var(--text);
  font-size: 0.95rem;
  box-shadow: 0 10px 28px rgba(148, 163, 184, 0.18);
}

input:focus {
  outline: 2px solid var(--accent);
  outline-offset: 2px;
}

.error {
  margin-top: 0.5rem;
  font-size: 0.85rem;
  color: var(--danger);
}

.view { display: none; }
.view.active { display: block; }

.actions {
  display: flex;
  gap: 0.6rem;
}

.actions > * { flex: 1; }

button {
  border-radius: 999px;
  border: none;
  padding: 0.55rem 0.95rem;
  font-size: 0.9rem;
  cursor: pointer;
  transition: transform 0.15s ease-out, box-shadow 0.15s ease-out, background 0.15s ease-out;
}

button:disabled { opacity: 0.6; cursor: default; }

.btn-primary {
  background: linear-gradient(135deg, #ec4899, #a855f7, #3b82f6);
  color: white;
  box-shadow: 0 14px 40px rgba(236, 72, 153, 0.35);
}

.btn-primary:hover:not(:disabled) {
  transform: translateY(-1px) scale(1.01);
  box-shadow: 0 18px 55px rgba(236, 72, 153, 0.5);
}

.btn-secondary {
  background: rgba(255, 255, 255, 0.95);
  color: var(--text);
  border: 1px solid rgba(209, 213, 219, 0.9);
  box-shadow: 0 10px 28px rgba(148, 163, 184, 0.18);
}

.btn-secondary:hover:not(:disabled) {
  transform: translateY(-1px);
  background: #ffffff;
  box-shadow: 0 14px 35px rgba(148, 163, 184, 0.24);
}

.grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(190px, 1fr));
  gap: 0.9rem;
}

.card {
  background: linear-gradient(135deg, rgba(255, 255, 255, 0.98), #fdf2ff);
  border-radius: 1.25rem;
  border: 1px solid rgba(233, 213, 255, 0.9);
  padding: 0.7rem;
  box-shadow: 0 18px 45px rgba(148, 163, 184, 0.22);
  cursor: pointer;
  display: flex;
  flex-direction: column;
  gap: 0.35rem;
}

.card:hover {
  transform: translateY(-3px);
  box-shadow: 0 24px 60px rgba(148, 163, 184, 0.32);
  border-color: rgba(236, 72, 153, 0.65);
}

.card-img {
  width: 100%;
  height: 180px;
  object-fit: cover;
  border-radius: 1rem;
  border: 1px solid rgba(233, 213, 255, 0.85);
}

.card-title {
  font-size: 0.95rem;
  font-weight: 700;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}

.card-desc {
  font-size: 0.85rem;
  color: var(--text-muted);
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}

.tags {
  display: flex;
  flex-wrap: wrap;
  gap: 0.35rem;
}

.tag {
  font-size: 0.72rem;
  padding: 0.18rem 0.55rem;
  border-radius: 999px;
  background: rgba(236, 72, 153, 0.08);
  color: #9d174d;
}

.card-footer {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 0.6rem;
  margin-top: 0.25rem;
  flex-wrap: wrap;
}

.card-footer button {
  padding: 0.45rem 0.85rem;
  font-size: 0.85rem;
  white-space: nowrap;
}

.card-footer .badge {
  white-space: nowrap;
}

.badge {
  font-size: 0.8rem;
  color: var(--text-muted);
}

.footer {
  border-top: 1px solid var(--border);
  background: rgba(255, 255, 255, 0.72);
  backdrop-filter: blur(14px);
}

.footer-inner {
  padding: 0.75rem 1.25rem;
  font-size: 0.85rem;
  color: var(--text-muted);
  display: flex;
  justify-content: space-between;
}

@media (max-width: 1024px) {
  body { overflow: auto; }
  .shell { height: auto; min-height: 100vh; }
  main { overflow: visible; }
  .layout.cols-3 { grid-template-columns: 1fr; }
  .panel-body { max-height: none; }
}
  </style>
</head>
<body>
<div class="shell">
  <header class="header">
    <div class="header-inner">
      <a class="brand" href="#home">MoodCart</a>
      <nav class="nav" aria-label="Primary">
        <a data-nav href="#home">Home</a>
        <a data-nav href="#feed">Feed</a>
        <a data-nav href="#saved">Saved</a>
        <a data-nav id="nav-login" href="#auth">Login</a>
      </nav>
      <div class="nav-right">
        <div class="status" id="auth-status"></div>
        <button class="btn-secondary" id="btn-logout" type="button" style="display:none;">Logout</button>
      </div>
    </div>
  </header>

  <main>
    <section class="view" id="view-home" data-view="home">
      <div class="layout cols-3">
        <section class="panel">
          <div class="panel-header">
            <h2>Start Here</h2>
            <div class="hint">Search your vibe, then Like + Save what you love.</div>
          </div>
          <div class="panel-body">
            <div class="row">
              <a class="btn-primary" style="display:inline-flex; align-items:center; justify-content:center;" href="#feed">Go to Vibe Feed</a>
              <a class="btn-secondary" style="display:inline-flex; align-items:center; justify-content:center;" href="#saved">Open Mood Board</a>
              <a class="btn-secondary" style="display:inline-flex; align-items:center; justify-content:center;" href="#auth">Login / Sign up</a>
            </div>
          </div>
        </section>

        <section class="panel">
          <div class="panel-header">
            <h2>Trending</h2>
          </div>
          <div class="panel-body">
            <div class="grid" id="trending-grid-home"></div>
          </div>
        </section>

        <section class="panel">
          <div class="panel-header">
            <h2>Quick Tips</h2>
            <div class="hint">Click a card to open product link.</div>
          </div>
          <div class="panel-body">
            <div class="row">
              <div><strong>Like</strong> and <strong>Save</strong> require login.</div>
              <div>Try vibes like: <em>soft girl</em>, <em>dark academia</em>, <em>streetwear</em>.</div>
            </div>
          </div>
        </section>
      </div>
    </section>

    <section class="view" id="view-feed" data-view="feed">
      <div class="layout cols-3" style="grid-template-columns: minmax(260px, 360px) minmax(0, 1fr) minmax(260px, 360px);">
        <section class="panel">
          <div class="panel-header">
            <h2>Vibe Search</h2>
            <div class="hint">Try: soft girl â€¢ coquette â€¢ dark academia â€¢ streetwear â€¢ cozy night</div>
          </div>
          <div class="panel-body">
            <form id="vibe-form" class="row">
              <label>
                Describe your vibe
                <input type="text" id="vibe-input" placeholder="soft girl, dark academia, cozy night, ..." />
              </label>
              <div class="actions">
                <button class="btn-primary" type="submit">Show products</button>
                <button class="btn-secondary" type="button" id="btn-clear">Clear</button>
              </div>
            </form>
          </div>
        </section>

        <section class="panel">
          <div class="panel-header">
            <h2 id="feed-title">Mood Feed</h2>
          </div>
          <div class="panel-body">
            <div class="grid" id="feed-grid">Type a vibe to see results.</div>
          </div>
        </section>

        <section class="panel">
          <div class="panel-header">
            <h2>Trending</h2>
          </div>
          <div class="panel-body">
            <div class="grid" id="trending-grid-feed"></div>
          </div>
        </section>
      </div>
    </section>

    <section class="view" id="view-saved" data-view="saved">
      <div class="layout cols-3" style="grid-template-columns: minmax(260px, 360px) minmax(0, 1fr) minmax(260px, 360px);">
        <section class="panel">
          <div class="panel-header">
            <h2>Quick Actions</h2>
            <div class="hint">Saved is your mood board. Login required.</div>
          </div>
          <div class="panel-body">
            <div class="row">
              <button class="btn-primary" id="btn-refresh" type="button">Refresh Saved</button>
              <a class="btn-secondary" style="display:inline-flex; align-items:center; justify-content:center;" href="#feed">Find more products</a>
            </div>
          </div>
        </section>

        <section class="panel">
          <div class="panel-header">
            <h2>Your Mood Board</h2>
          </div>
          <div class="panel-body">
            <div class="grid" id="saved-grid"></div>
          </div>
        </section>

        <section class="panel">
          <div class="panel-header">
            <h2>Trending</h2>
          </div>
          <div class="panel-body">
            <div class="grid" id="trending-grid-saved"></div>
          </div>
        </section>
      </div>
    </section>

    <section class="view" id="view-auth" data-view="auth">
      <div class="layout" style="grid-template-columns: minmax(0, 520px); justify-content: center; height: 100%;">
        <section class="panel">
          <div class="panel-header">
            <h2>Login / Sign up</h2>
            <div class="hint">Login to Like + Save products.</div>
          </div>
          <div class="panel-body">
            <form id="auth-form" class="row">
              <label>
                Email
                <input type="email" id="auth-email" required />
              </label>
              <label>
                Username (for signup)
                <input type="text" id="auth-username" placeholder="optional" />
              </label>
              <label>
                Password
                <input type="password" id="auth-password" required />
              </label>
              <div class="actions">
                <button class="btn-primary" id="btn-login" type="button">Login</button>
                <button class="btn-secondary" id="btn-signup" type="button">Sign up</button>
              </div>
              <div class="error" id="auth-error"></div>
            </form>
          </div>
        </section>
      </div>
    </section>
  </main>

  <footer class="footer">
    <div class="footer-inner">
      <div>Find your vibe. Shop your mood.</div>
      <div>&copy; <span id="year"></span> MoodCart</div>
    </div>
  </footer>
</div>

<script>
const apiBase = '';

const Auth = {
  state: {
    token: null,
    email: null,
    username: null,
    role: null,
  },

  load() {
    try {
      const raw = localStorage.getItem('moodcart_auth');
      if (!raw) return;
      const parsed = JSON.parse(raw);
      if (parsed && parsed.token) {
        this.state = parsed;
      }
    } catch (_) {}
  },

  save() {
    localStorage.setItem('moodcart_auth', JSON.stringify(this.state));
  },

  clear() {
    this.state = { token: null, email: null, username: null, role: null };
    localStorage.removeItem('moodcart_auth');
  },

  isLoggedIn() {
    return !!this.state.token;
  },
};

async function apiRequest(path, options = {}) {
  const headers = options.headers || {};
  headers['Content-Type'] = 'application/json';
  if (Auth.state.token) {
    headers['Authorization'] = `Bearer ${Auth.state.token}`;
  }
  const res = await fetch(apiBase + path, { ...options, headers });
  if (!res.ok) {
    let msg = `HTTP ${res.status}`;
    try {
      const data = await res.json();
      if (data && data.message) msg = data.message;
    } catch (_) {}
    throw new Error(msg);
  }
  const ct = res.headers.get('content-type') || '';
  if (ct.includes('application/json')) {
    return res.json();
  }
  return null;
}

function setActiveNav() {
  const view = getRoute();
  const activeHref = `#${view}`;
  document.querySelectorAll('[data-nav]')?.forEach((a) => {
    const href = (a.getAttribute('href') || '').toLowerCase();
    a.classList.toggle('active', href === activeHref);
  });
}

function updateHeaderAuth() {
  const statusEl = document.getElementById('auth-status');
  const loginLink = document.getElementById('nav-login');
  const logoutBtn = document.getElementById('btn-logout');

  if (!statusEl) return;

  if (!Auth.isLoggedIn()) {
    statusEl.textContent = 'Not logged in';
    if (logoutBtn) logoutBtn.style.display = 'none';
    if (loginLink) loginLink.style.display = 'inline-flex';
  } else {
    const username = (Auth.state.username || '').trim();
    const email = (Auth.state.email || '').trim();
    const emailPrefix = email.includes('@') ? email.split('@')[0] : email;
    const name = (username.length >= 2 ? username : (emailPrefix || username || 'user'));
    statusEl.textContent = `Hi, ${name}`;
    if (logoutBtn) logoutBtn.style.display = 'inline-flex';
    if (loginLink) loginLink.style.display = 'none';
  }
}

function wireLogout() {
  const btn = document.getElementById('btn-logout');
  if (!btn) return;
  btn.addEventListener('click', () => {
    Auth.clear();
    updateHeaderAuth();
    if (getRoute() === 'saved') location.hash = '#auth';
  });
}

function getRoute() {
  const raw = (location.hash || '').trim().toLowerCase();
  const view = raw.startsWith('#') ? raw.slice(1) : raw;
  if (view === 'home' || view === 'feed' || view === 'saved' || view === 'auth') return view;
  return 'home';
}

function showView(view) {
  document.querySelectorAll('.view')?.forEach((el) => {
    el.classList.toggle('active', (el.getAttribute('data-view') || '') === view);
  });
}

function parseTags(product) {
  if (!product || product.tags == null) return [];
  if (Array.isArray(product.tags)) return product.tags;
  return String(product.tags)
    .split(',')
    .map((t) => t.trim())
    .filter(Boolean);
}

function normalizeBoolean(product, keyA, keyB) {
  if (!product) return false;
  const a = product[keyA];
  if (a !== undefined && a !== null) return !!a;
  const b = product[keyB];
  return !!b;
}

function normalizePrice(product) {
  const raw = product?.price;
  const priceNum = typeof raw === 'number' ? raw : parseFloat(raw);
  return Number.isFinite(priceNum) ? priceNum : null;
}

function productCard(product, options = {}) {
  const { canInteract, isSaved } = options;

  const card = document.createElement('div');
  card.className = 'card';

  const productUrl = product?.affiliateUrl || product?.url || product?.productUrl || '';
  if (productUrl) {
    card.title = 'Open product in a new tab';
    card.addEventListener('click', () => window.open(productUrl, '_blank', 'noopener'));
  } else {
    card.style.cursor = 'default';
  }

  if (product?.imageUrl) {
    const img = document.createElement('img');
    img.className = 'card-img';
    img.src = product.imageUrl;
    img.alt = product.title || 'Product image';
    img.loading = 'lazy';
    card.appendChild(img);
  }

  const title = document.createElement('div');
  title.className = 'card-title';
  title.textContent = product?.title || 'Untitled';
  card.appendChild(title);

  if (product?.description) {
    const desc = document.createElement('div');
    desc.className = 'card-desc';
    desc.textContent = product.description;
    card.appendChild(desc);
  }

  const tags = parseTags(product);
  if (tags.length) {
    const tagsEl = document.createElement('div');
    tagsEl.className = 'tags';
    tags.slice(0, 6).forEach((t) => {
      const tag = document.createElement('span');
      tag.className = 'tag';
      tag.textContent = t;
      tagsEl.appendChild(tag);
    });
    card.appendChild(tagsEl);
  }

  const footer = document.createElement('div');
  footer.className = 'card-footer';

  const left = document.createElement('div');
  const price = normalizePrice(product);
  left.textContent = price != null ? `â‚¹${price.toFixed(2)}` : '';

  const right = document.createElement('div');
  right.style.display = 'flex';
  right.style.gap = '0.5rem';
  right.style.alignItems = 'center';

  const stats = document.createElement('span');
  stats.className = 'badge';
  stats.textContent = `â¤ ${product?.likesCount ?? 0} Â· ðŸ’¾ ${product?.savesCount ?? 0}`;
  right.appendChild(stats);

  if (canInteract) {
    const likeBtn = document.createElement('button');
    likeBtn.type = 'button';
    likeBtn.className = 'btn-secondary';
    likeBtn.textContent = normalizeBoolean(product, 'likedByCurrentUser', 'liked') ? 'Unlike' : 'Like';
    likeBtn.addEventListener('click', async (e) => {
      e.stopPropagation();
      if (!Auth.isLoggedIn()) {
        alert('Login first to like products.');
        return;
      }
      try {
        const currentlyLiked = normalizeBoolean(product, 'likedByCurrentUser', 'liked');
        const ref = {
          productId: product.id ?? null,
          externalId: product.externalId ?? null,
          title: product.title,
          imageUrl: product.imageUrl,
          price: product.price,
          affiliateUrl: product.affiliateUrl,
          tags: product.tags,
        };

        if (product.id != null) {
          await apiRequest(`/api/products/${product.id}/like`, { method: currentlyLiked ? 'DELETE' : 'POST' });
        } else {
          await apiRequest(currentlyLiked ? '/api/products/unlike' : '/api/products/like', {
            method: 'POST',
            body: JSON.stringify(ref),
          });
        }

        if (currentlyLiked) {
          product.likedByCurrentUser = false;
          product.liked = false;
          product.likesCount = (product.likesCount || 1) - 1;
        } else {
          product.likedByCurrentUser = true;
          product.liked = true;
          product.likesCount = (product.likesCount || 0) + 1;
        }
        likeBtn.textContent = normalizeBoolean(product, 'likedByCurrentUser', 'liked') ? 'Unlike' : 'Like';
        stats.textContent = `â¤ ${product.likesCount ?? 0} Â· ðŸ’¾ ${product.savesCount ?? 0}`;
      } catch (err) {
        alert(err?.message || 'Failed to update like.');
      }
    });

    const saveBtn = document.createElement('button');
    saveBtn.type = 'button';
    saveBtn.className = 'btn-primary';
    saveBtn.textContent = isSaved || normalizeBoolean(product, 'savedByCurrentUser', 'saved') ? 'Unsave' : 'Save';
    saveBtn.addEventListener('click', async (e) => {
      e.stopPropagation();
      if (!Auth.isLoggedIn()) {
        alert('Login first to save products.');
        return;
      }
      try {
        const currentlySaved = normalizeBoolean(product, 'savedByCurrentUser', 'saved');
        const ref = {
          productId: product.id ?? null,
          externalId: product.externalId ?? null,
          title: product.title,
          imageUrl: product.imageUrl,
          price: product.price,
          affiliateUrl: product.affiliateUrl,
          tags: product.tags,
        };

        if (isSaved || currentlySaved) {
          if (product.id != null) {
            await apiRequest(`/api/products/${product.id}/save`, { method: 'DELETE' });
          } else {
            await apiRequest('/api/products/unsave', { method: 'POST', body: JSON.stringify(ref) });
          }
          product.savedByCurrentUser = false;
          product.saved = false;
          product.savesCount = Math.max(0, (product.savesCount || 0) - 1);
        } else if (product.id != null) {
          await apiRequest('/api/products/save', {
            method: 'POST',
            body: JSON.stringify({ productId: product.id }),
          });
          product.savedByCurrentUser = true;
          product.saved = true;
          product.savesCount = (product.savesCount || 0) + 1;
        } else {
          const ref = {
            productId: null,
            externalId: product.externalId ?? null,
            title: product.title,
            imageUrl: product.imageUrl,
            price: product.price,
            affiliateUrl: product.affiliateUrl,
            tags: product.tags,
          };
          await apiRequest('/api/products/save-external', {
            method: 'POST',
            body: JSON.stringify(ref),
          });
          product.savedByCurrentUser = true;
          product.saved = true;
          product.savesCount = (product.savesCount || 0) + 1;
        }
        saveBtn.textContent = (isSaved || normalizeBoolean(product, 'savedByCurrentUser', 'saved')) ? 'Unsave' : 'Save';
        stats.textContent = `â¤ ${product.likesCount ?? 0} Â· ðŸ’¾ ${product.savesCount ?? 0}`;
      } catch (err) {
        alert(err?.message || 'Failed to save product.');
      }
    });

    right.appendChild(likeBtn);
    right.appendChild(saveBtn);
  }

  footer.appendChild(left);
  footer.appendChild(right);
  card.appendChild(footer);

  return card;
}

async function loadTrending(targetId, size = 12) {
  const grid = document.getElementById(targetId);
  if (!grid) return;
  grid.textContent = 'Loading trendingâ€¦';
  try {
    const data = await apiRequest(`/api/products/trending?page=0&size=${size}`);
    grid.innerHTML = '';
    (data.products || []).forEach((p) => grid.appendChild(productCard(p, { canInteract: true })));
  } catch (err) {
    grid.textContent = err?.message || 'Failed to load trending.';
  }
}

async function loadVibeFeed(query, targetId, titleId) {
  const grid = document.getElementById(targetId);
  const title = document.getElementById(titleId);
  if (title) title.textContent = query ? `Mood Feed â€“ ${query}` : 'Mood Feed';
  if (!grid) return;
  const q = (query || '').trim();
  if (!q) {
    grid.textContent = 'Type a vibe to see results.';
    return;
  }
  grid.textContent = 'Loading feedâ€¦';
  try {
    const data = await apiRequest(`/api/moods/vibe-feed?q=${encodeURIComponent(q)}&page=0&size=20`);
    grid.innerHTML = '';
    (data.products || []).forEach((p) => grid.appendChild(productCard(p, { canInteract: true })));
  } catch (err) {
    grid.textContent = err?.message || 'Failed to load feed.';
  }
}

async function loadSaved(targetId, size = 30) {
  const grid = document.getElementById(targetId);
  if (!grid) return;
  grid.textContent = 'Loading savedâ€¦';
  try {
    const data = await apiRequest(`/api/products/saved?page=0&size=${size}`);
    grid.innerHTML = '';
    (data.products || []).forEach((p) => grid.appendChild(productCard(p, { canInteract: true, isSaved: true })));
  } catch (err) {
    grid.textContent = err?.message || 'Failed to load saved products.';
  }
}

async function loginOrSignup(mode, email, username, password) {
  const body = { email, password };
  if (mode === 'signup' && username) body.username = username;
  const endpoint = mode === 'login' ? '/api/auth/login' : '/api/auth/signup';
  const data = await apiRequest(endpoint, { method: 'POST', body: JSON.stringify(body) });
  Auth.state = { token: data.token, email: data.email, username: data.username, role: data.role };
  Auth.save();
}

async function runRoute() {
  const view = getRoute();

  if (view === 'saved' && !Auth.isLoggedIn()) {
    const errEl = document.getElementById('auth-error');
    if (errEl) errEl.textContent = 'Login required to view Saved.';
    location.hash = '#auth';
    return;
  }

  if (view === 'auth' && Auth.isLoggedIn()) {
    location.hash = '#home';
    return;
  }

  showView(view);
  setActiveNav();
  updateHeaderAuth();

  if (view === 'home') {
    await loadTrending('trending-grid-home', 12);
  }
  if (view === 'feed') {
    await loadTrending('trending-grid-feed', 12);
  }
  if (view === 'saved') {
    await loadSaved('saved-grid', 30);
    await loadTrending('trending-grid-saved', 10);
  }
}

function initShell() {
  Auth.load();
  if (!location.hash) location.hash = '#home';
  showView(getRoute());
  setActiveNav();
  updateHeaderAuth();
  wireLogout();

  const year = document.getElementById('year');
  if (year) year.textContent = new Date().getFullYear();

  const vibeForm = document.getElementById('vibe-form');
  const vibeInput = document.getElementById('vibe-input');
  if (vibeForm && vibeInput) {
    vibeForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      await loadVibeFeed((vibeInput.value || '').trim(), 'feed-grid', 'feed-title');
    });
  }

  const clearBtn = document.getElementById('btn-clear');
  if (clearBtn && vibeInput) {
    clearBtn.addEventListener('click', () => {
      vibeInput.value = '';
      const title = document.getElementById('feed-title');
      const grid = document.getElementById('feed-grid');
      if (title) title.textContent = 'Mood Feed';
      if (grid) grid.textContent = 'Type a vibe to see results.';
    });
  }

  const refreshBtn = document.getElementById('btn-refresh');
  if (refreshBtn) refreshBtn.addEventListener('click', () => loadSaved('saved-grid', 30));

  const loginBtn = document.getElementById('btn-login');
  const signupBtn = document.getElementById('btn-signup');

  async function submitAuth(mode) {
    const email = document.getElementById('auth-email')?.value?.trim() || '';
    const username = document.getElementById('auth-username')?.value?.trim() || '';
    const password = document.getElementById('auth-password')?.value?.trim() || '';
    const errEl = document.getElementById('auth-error');
    if (errEl) errEl.textContent = '';
    if (!email || !password) {
      if (errEl) errEl.textContent = 'Email and password are required.';
      return;
    }
    try {
      await loginOrSignup(mode, email, username, password);
      updateHeaderAuth();
      location.hash = '#home';
    } catch (err) {
      if (errEl) errEl.textContent = err?.message || 'Authentication failed.';
    }
  }

  if (loginBtn) loginBtn.addEventListener('click', () => submitAuth('login'));
  if (signupBtn) signupBtn.addEventListener('click', () => submitAuth('signup'));

  window.addEventListener('hashchange', () => { runRoute(); });
  runRoute();
}

window.MoodCartUI = {
  Auth,
  apiRequest,
  initShell,
  loadTrending,
  loadVibeFeed,
  loadSaved,
  loginOrSignup,
};
</script>
<script>
  MoodCartUI.initShell();
</script>
</body>
</html>
